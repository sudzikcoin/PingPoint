You are the Replit Backend Agent working on the existing PingPoint / `agentos-tracking-core` project (Next.js App Router + TypeScript + Prisma + Tailwind).

IMPORTANT: The current **logic of broker onboarding via magic link is correct and MUST NOT be changed.**  
Right now, when a broker receives a link to create a load, fills the form, we generate a link and “pretend” to send it, but there is no real transactional email integration.

GOAL: 
- Keep the existing flow EXACTLY as it is (same tokens, same URLs, same auth logic).
- Find the place(s) where we currently create the broker magic link / workspace link and only **wire a real email sender** instead of console logging / TODO stubs.
- Use an external email provider (e.g. Resend or an existing mail helper) via environment variables so emails can actually be delivered.

Do NOT:
- Change how tokens are generated.
- Change how links are validated.
- Change redirects or routing logic.
- Change driver / tracking logic.

Only add/modify the MAILING implementation.

────────────────────────
1. DISCOVER CURRENT MAGIC-LINK / INVITE IMPLEMENTATION
────────────────────────

1) Search the codebase for the existing broker invite / magic link flow. Look for:
   - Generation of a one-time token and a URL (something like `/app/loads`, `/app/loads/new`, `/app/auth/magic`, `/broker/verify`, etc).
   - Code that currently logs or mocks sending an email, e.g.:
     - `console.log("Verification link:", url)`
     - `// TODO: send email`
     - or a placeholder `sendEmail` that doesn’t really send.

2) Identify:
   - The function or API route that is called **right after the broker fills the load creation form** and where we now “pretend” to send the email.
   - The exact URL that is generated (keep it as-is; this is the magic link we must email).

Do NOT refactor the flow. Only note where the link is generated and where we should call the real mailer.

────────────────────────
2. CREATE / USE A CENTRAL EMAIL HELPER
────────────────────────

We want a single reusable function for sending emails.

1) Check if there is already an email helper (e.g. `src/lib/email.ts`, `src/lib/mail.ts`, `src/server/email.ts`):
   - If it exists and already uses a real provider (like Resend, SendGrid, Postmark), reuse and extend it.
   - If it exists but is only a stub (no external call), upgrade it to send real emails (see below).
   - If none exists, create `src/lib/email.ts`.

2) Implement email sending using a single provider. Prefer a simple REST API like **Resend** or similar. Example (adapt to the provider you choose):

   - Add a dependency in `package.json` if needed (for example `"resend": "^2.x"`), and run `npm install` / `pnpm add`.

   - In `src/lib/email.ts`:

     ```ts
     // Example using Resend – adapt if you discover another provider already chosen.
     import { Resend } from "resend";

     const resendApiKey = process.env.RESEND_API_KEY;
     const defaultFrom = process.env.MAIL_FROM || "no-reply@pingpoint.app";

     if (!resendApiKey) {
       console.warn("RESEND_API_KEY is not set; email sending will not work in production.");
     }

     const resend = resendApiKey ? new Resend(resendApiKey) : null;

     export async function sendTransactionalEmail(params: {
       to: string;
       subject: string;
       html: string;
       text?: string;
       from?: string;
     }) {
       if (!resend) {
         console.log("[DEV] Would send email:", params);
         return;
       }

       await resend.emails.send({
         from: params.from || defaultFrom,
         to: params.to,
         subject: params.subject,
         html: params.html,
         text: params.text,
       });
     }
     ```

   - Make sure to use environment variables:
     - `RESEND_API_KEY` as a secret in Replit.
     - `MAIL_FROM` for the “from” address (e.g. `no-reply@pingpoint.app`).

3) If there is already a provider configured (Postmark / SendGrid / SES), use that instead of Resend.  
   The key requirement: **`sendTransactionalEmail({ to, subject, html, text })` must actually send an email** in production.

────────────────────────
3. HOOK EMAIL SENDING INTO EXISTING BROKER MAGIC-LINK FLOW
────────────────────────

Now wire the helper into the real flow where we generate the magic link for the broker.

1) Go to the API handler / server action that runs **after a broker fills the “create load” form** and we currently:

   - generate a token (magic link / invite),
   - build a URL,
   - and either:
     - console.log it, or
     - set a field like `verificationLink`, or
     - have a `TODO: send email`.

2) Import the email helper:

   ```ts
   import { sendTransactionalEmail } from "@/lib/email";

	3.	Right after the URL is generated and persisted, call sendTransactionalEmail:
	•	Determine the broker email to send to (use the same email you currently show in the banner and expect to verify — usually from the load form or broker profile).
Example (simplified):

const magicLinkUrl = /* existing logic that builds the URL */;
const brokerEmail = /* existing logic to determine broker email */;

if (brokerEmail) {
  await sendTransactionalEmail({
    to: brokerEmail,
    subject: "Your PingPoint access link",
    text: `Hello,\n\nHere is your secure link to access your PingPoint load and dashboard:\n\n${magicLinkUrl}\n\nIf you did not request this link, you can ignore this email.\n`,
    html: `
      <p>Hello,</p>
      <p>Here is your secure link to access your PingPoint load and dashboard:</p>
      <p><a href="${magicLinkUrl}" style="display:inline-block;padding:10px 18px;border-radius:9999px;background:#111827;color:#facc15;text-decoration:none;font-weight:600;">Open PingPoint</a></p>
      <p>Or copy and paste this URL into your browser:</p>
      <p><code>${magicLinkUrl}</code></p>
      <p>If you did not request this link, you can safely ignore this email.</p>
    `,
  });
} else {
  console.warn("No broker email found to send magic link.");
}


	4.	Do not change how magicLinkUrl is generated or how its token is stored/verified.
Only add the real email sending call instead of the placeholder.

────────────────────────
4. KEEP EXISTING REDIRECT / AUTH LOGIC UNCHANGED
────────────────────────

Make sure you do not modify:
	•	Any route that consumes the magic link (e.g. /auth/magic, /app/loads/magic, etc.).
	•	The shape of tokens or DB models used for validation.
	•	How the broker is logged in or how the workspace is created/activated after clicking the link.

If there is any earlier code or helper that used to “simulate” email sending by writing to logs / returning the URL to the frontend, you may keep it for debugging (logging is OK), but production behavior must now rely on actual email delivery.

────────────────────────
5. ADD REPLIT SECRETS AND TEST
────────────────────────
	1.	In Replit secrets / environment variables, set at least:
	•	RESEND_API_KEY = your real Resend API key (or provider equivalent).
	•	MAIL_FROM = the from address (e.g. no-reply@pingpoint.app).
	2.	Run the project and test end-to-end:
	•	Start from the broker invite / create-load entry point:
	•	Open the link that lets the broker create the first load.
	•	Fill all required fields.
	•	Submit.
	•	Confirm that:
	•	The magic link URL is generated as before.
	•	An email is actually sent to the broker’s email address with that link.
	•	Click the link in the email:
	•	The existing logic should log the broker in / activate the workspace just as before (no changes required here).
	3.	If RESEND_API_KEY is not present (e.g. in local dev), ensure that:
	•	No runtime error occurs.
	•	The helper falls back to logging the email content to console, so you can still test the link visually in dev.

────────────────────────
6. SUMMARY OF REQUIRED CHANGES
────────────────────────
	•	Create or update a central email helper (sendTransactionalEmail) that uses a real email provider (Resend or equivalent) via environment variables.
	•	Locate the current broker magic-link creation flow (where we previously “pretended” to send the link).
	•	Replace the stub/console/TODO with a call to sendTransactionalEmail, passing:
	•	broker email,
	•	subject,
	•	HTML + text that includes the existing magic link URL.
	•	Do NOT modify magic-link generation, token storage, or validation logic.
	•	Verify that a broker can now:
	•	Receive a real email after filling the load form.
	•	Click that link and be handled by the existing login/activation logic.

END OF INSTRUCTIONS

