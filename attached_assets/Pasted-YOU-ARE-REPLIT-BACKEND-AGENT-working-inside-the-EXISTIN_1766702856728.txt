YOU ARE REPLIT BACKEND AGENT working inside the EXISTING PinkPoint/PingPoint project.

META-RULES (STRICT):
- Make the smallest, most localized changes needed to fix THIS geolocation issue.
- Do NOT rename DB tables or break existing flows. Do NOT delete features.
- Keep existing API routes working. Add new routes only if necessary.
- Provide robust iOS Safari behavior. Add clear user-facing debug.
- After changes, the driver link MUST request location correctly on iPhone/iPad Safari and send pings to server.

GOAL:
Fix driver geolocation so iOS Safari reliably prompts/starts and pings are sent; prevent “infinite requesting” UI; make broker/public tracking show a REAL map with lastLocation marker.

CONTEXT OBSERVED:
- Driver UI often stuck at “Requesting location access…”
- iOS permission prompt sometimes appears, user allows, but UI still stuck and no pings are sent.
- Desktop browser returns wrong location (e.g., 34.05,-118.25) likely IP-based; these values get stored as lastLocation, confusing broker.

TASKS (IMPLEMENT EXACTLY):

A) DRIVER UI FIX (client/src/pages/driver-dashboard.tsx)
1) Replace any auto-start geolocation on page load with an explicit user gesture:
   - Add a prominent button: “Enable Location / Start Tracking”
   - ONLY when user taps the button, call a startTracking() that requests geolocation.
   - Never call getCurrentPosition/watchPosition inside useEffect on mount (iOS Safari can block).

2) Add a strict state machine:
   - state: 'idle' | 'requesting' | 'denied' | 'error' | 'active'
   - 'idle': show button + short explanation
   - 'requesting': show spinner + “Waiting for iOS permission…”
   - 'denied': show clear iOS instructions (aA -> Website Settings -> Location -> Allow; and iOS Settings -> Privacy -> Location -> Safari Websites)
   - 'error': show error message + “Try Again”
   - 'active': show “Tracking active” + last ping time + last coords + accuracy

3) Implement startTracking() behavior:
   - Use navigator.geolocation.getCurrentPosition first (to force permission prompt + get initial fix).
   - Options: { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
   - If it fails with TIMEOUT or POSITION_UNAVAILABLE, retry once with enableHighAccuracy:false.
   - On success, immediately sendPing(coords) then start watchPosition for continuous updates.
   - watchPosition options: { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
   - If watchPosition errors, transition to 'error' or 'denied' depending on code.

4) Send pings throttled:
   - Ensure pings are not spammed: send at most once every 60 seconds OR if moved > 50 meters.
   - Include load/tracking identifiers already used in the project (keep existing payload shape).
   - Add client-side logs with a stable prefix: [DriverGeo] and ALSO show last 10 log lines in an on-screen debug panel (collapsible) so mobile users can see what’s happening without console.

5) Validate coords and accuracy on client:
   - If coords are invalid (lat not in [-90,90], lng not in [-180,180]) do not send; show error.
   - If accuracy is very poor (e.g., > 5000 meters), show a yellow warning: “Low accuracy. Desktop browsers may use IP-based location (can be wrong).”
   - Still allow sending, but make it obvious.

6) Cleanup:
   - On component unmount, clear watchPosition watcher.
   - Ensure repeated clicks do not create multiple watchers (store watchId in ref).

B) SERVER: GUARANTEE PING ENDPOINT + LOGGING (server/routes.ts or existing server file)
1) Identify the existing ping endpoint used by driver (do NOT break it).
   - If it already exists: keep route path and request shape; improve validation + logging.
   - If it does not exist: create POST /api/driver/:driverId/ping (or whatever is consistent with current codebase) and wire it to update tracking record lastLocation and create a ping record if your schema supports it.

2) Add robust logging (server console):
   - On receiving a ping: [TrackingPing] recv load=... driver=... lat=... lng=... acc=... ts=...
   - On storing: [TrackingPing] STORED load=... at=...
   - On rejection: [TrackingPing] REJECTED load=... reason=... (invalid_coords / tracking_ended / missing_ids)

3) Server-side validation:
   - Reject invalid lat/lng with HTTP 400 and JSON { ok:false, error:'invalid_coords' }
   - Accept and store accuracy if provided.
   - Do NOT overwrite lastLocation with null or invalid coords.

4) IMPORTANT: Fix stale LA coordinates issue:
   - When a driver starts tracking for a load, lastLocation should update only from NEW pings.
   - Do not keep any hardcoded default coords.
   - If you find any fallback coords (34.05,-118.25) in code, remove them.
   - If old pings are being shown due to cached DB values, add a safe “reset lastLocation on new tracking session start” behavior:
     - When driver opens link and taps “Enable Location”, call a lightweight server endpoint to mark trackingSessionStartedAt=now and optionally clear lastLocation ONLY for that load if it has never received a valid ping in the current session.
     - This must be minimal and not break existing tracking history.

C) BROKER/PUBLIC TRACKING: REAL MAP
1) On the broker/public tracking page (the one showing “LIVE UPDATES / Waiting for driver…”), add a map block:
   - Use Leaflet (no API key) with OpenStreetMap tiles.
   - Show a marker at lastLocation if available.
   - If no lastLocation: show “No location yet”.
   - Update marker when polling fetch updates.
   - Keep existing UI. Add map as an additional section (collapsible is OK).

2) Polling:
   - The broker/public page already polls or fetches tracking; ensure it refreshes lastLocation every 10–15 seconds.
   - Display: “Last location update: X minutes ago (lat,lng)” and marker.

D) CACHE / “STUCK ON OLD UI” PROTECTION
1) Ensure the driver page is not stuck on an old cached bundle:
   - If there is a service worker/PWA caching, disable it for now.
   - Add Cache-Control: no-store for HTML responses for driver/public pages in Express.
   - For static assets, keep default, but ensure HTML is no-store so new JS is picked up.

E) TEST CHECKLIST (MUST PASS)
1) iPhone Safari:
   - Open driver link -> sees “Enable Location / Start Tracking” button (NOT infinite requesting).
   - Tap button -> iOS permission prompt appears.
   - Choose “Allow while using” -> UI becomes “Tracking active”, shows coords + last ping time.
   - Server logs show [TrackingPing] recv + STORED every ~60s.

2) iPad Safari:
   - Same as above.

3) Desktop browser:
   - If location services disabled, app still works but shows “Low accuracy / IP-based” warning if accuracy poor.

4) Broker/public page:
   - Map appears with marker after first ping.
   - Marker updates as pings come in.

DELIVERABLE:
- Implement changes in the existing files (do not create a new app).
- Keep changes minimal and safe.
- After implementation, run the app and ensure logs show pings.
- Summarize which files changed and what was fixed.

START NOW.