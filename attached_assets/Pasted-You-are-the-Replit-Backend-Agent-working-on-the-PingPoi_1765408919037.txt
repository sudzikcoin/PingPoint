You are the Replit Backend Agent working on the **PingPoint** project already loaded in this workspace.

The user reports a critical regression:

> On the FIRST creation of a load (on `/app/loads/new`), when they click **“Create Load”**, nothing happens:
> - No load appears in the broker console,
> - No verification email is effectively used,
> - No clear error is shown (just feels like “button does nothing”).

Your goal in THIS run is:

1. Find and FIX the root cause so that the **first load can be created successfully**.
2. Improve the **error reporting** on the frontend so that if something goes wrong, the broker sees a meaningful message (not just “Failed to create load”).
3. Keep changes focused and minimal. Do NOT refactor all flows, do NOT touch design, do NOT break existing tests.

You will work in a few small tasks.

────────────────────────
CONSTRAINTS
────────────────────────

- Do NOT change the overall business flows:
  - Broker fills `New Load` form → click “Create Load” → backend creates/ensures broker + load → sends verification email → redirect to `/app/loads`.
  - Driver & public tracking must continue to work.
- Do NOT introduce big schema or flow changes (no new verification logic, no hints logic here).
- Limit changes to:
  - The `/api/brokers/ensure` + `/api/loads` logic (if needed),
  - The frontend code around `New Load` submit and API error handling,
  - Very small additional logs / tests.

Focus on **making first load creation work reliably and surfacing errors clearly**.

────────────────────────
TASK 1 – Reproduce & identify where it breaks
────────────────────────

1. Run the app in dev mode (`npm run dev` or the existing dev script) inside this Replit workspace.

2. Simulate the user flow for a completely new broker:
   - Open the frontend route for **New Load** (e.g. `/app/loads/new`).
   - Fill the form with realistic data:
     - Broker email: some valid address with `@`.
     - Driver phone: any number format accepted by validation.
     - Shipper/receiver, pickup/delivery, etc. (anything required).
   - Click **Create Load**.

3. Watch:
   - **Browser Network tab** (or the devtools-equivalent logs you can inspect via console output):
     - Does the frontend send requests to `/api/brokers/ensure` and `/api/loads`?
     - What are the HTTP statuses (200, 400, 403, 500)?
     - What is the JSON response body?
   - **Server logs** (console output):
     - Any errors from `/api/brokers/ensure`?
     - Any errors from `/api/loads`?
     - Stack traces?

4. Based on this, decide:
   - Is the failure happening in `/api/brokers/ensure` (broker creation/lookup)?
   - Or in `/api/loads` (load creation, DB, email, etc.)?
   - Or is the frontend not even sending the request (front validation early exit)?

DO NOT guess. Use actual code and runtime logs to pinpoint the failing step.

────────────────────────
TASK 2 – Fix the underlying backend error that blocks first load creation
────────────────────────

Once you know where it fails:

1. If the problem is in `/api/brokers/ensure`:
   - Check the handler:
     - It must accept JSON body with `email` and `name`.
     - It must normalize email (trim, lowercase).
     - It must either find existing broker or create a new one.
     - It must return 200 with broker data.
   - Fix any issues:
     - Missing `app.use(express.json())` before this route,
     - Typos in field names,
     - Incorrect DB calls (e.g. wrong table/column),
     - Throwing errors instead of handling them.
   - Ensure that for a fresh email, it creates a broker and returns a JSON with at least an `id` and `email`.

2. If the problem is in `/api/loads`:
   - Inspect the load creation handler. Confirm:
     - It reads the correct fields from `req.body` (brokerEmail, driverPhone, stops, etc.).
     - It can create or use an existing broker correctly, especially on first run.
     - It handles driver creation and stop creation without throwing.
     - It does NOT crash on missing optional fields (e.g. carrierName can be nullable).
   - Fix specific errors you find:
     - Add proper validation for required fields and return 400 with a clear error message (e.g. `"Broker email is required"`, `"Driver phone is required"`, `"Pickup and delivery stops are required"`).
     - Correct any DB queries that reference misnamed columns or relations.
     - Wrap email/SMS sending in try/catch with a clear error log so a failure there does not hide the actual cause.

3. Ensure both routes:
   - Return **specific JSON error messages** on failure, e.g.:

     ```json
     { "error": "BROKER_EMAIL_REQUIRED", "message": "Broker email is required" }
     ```

   - Do NOT swallow errors silently. Log them on the server (`console.error`) and return a structured JSON error with an appropriate HTTP status.

4. Add or update a **small backend test** (Vitest) that:
   - Calls the load creation endpoint with valid data for a brand-new email.
   - Asserts that the HTTP status is 200/201.
   - Asserts that a load record is created and returned.

────────────────────────
TASK 3 – Improve frontend error handling for Create Load
────────────────────────

Even if backend is fixed, we want the broker to see **meaningful** error messages when something goes wrong, not just “Failed to create load”.

1. Find the frontend New Load page/component:
   - Likely something like `client/src/.../NewLoadPage` or similar.
   - It has a `handleSubmit` function that:
     - `preventDefault()`,
     - Does some client-side validation,
     - Calls `api.brokers.ensure(...)`,
     - Then calls `api.loads.create(...)`,
     - Shows toasts and redirects.

2. In the frontend API layer (e.g. `client/src/api.ts` or wherever `api.loads.create` and `api.brokers.ensure` are defined):

   - Update these functions to read and propagate error messages from the server:

     Example pattern for `api.loads.create`:

     ```ts
     async function createLoad(payload: NewLoadPayload) {
       const res = await fetch("/api/loads", {
         method: "POST",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify(payload),
       });

       if (!res.ok) {
         let message = "Failed to create load";
         try {
           const data = await res.json();
           if (data?.message) message = data.message;
           else if (data?.error) message = data.error;
         } catch {
           // ignore JSON parse errors, keep default message
         }
         throw new Error(message);
       }

       return res.json();
     }
     ```

     Do something similar for `api.brokers.ensure` so it throws an `Error` with a good message extracted from the backend.

3. In `handleSubmit` for New Load:

   - In the `catch (error)` block, use the error message from the thrown Error:

     ```ts
     } catch (error: any) {
       console.error("Failed to create load", error);
       const message = error?.message || "Failed to create load. Please try again.";
       toast.error(message);
     } finally {
       setIsSubmitting(false);
     }
     ```

   - Ensure `setIsSubmitting(false)` is always executed (in `finally`).

4. Optional improvement (do it only if it’s clear and safe):

   - Today you may have BOTH:
     - `api.brokers.ensure(...)` AND
     - `api.loads.create(...)` doing their own broker creation/ensure logic.
   - If you confirm that `/api/loads` already creates/uses a broker based on email, you may:
     - Remove the redundant pre-call to `/api/brokers/ensure` from the first load creation flow,
     - And rely on `/api/loads` as the single source of truth for broker creation.
   - If it’s not 100% obvious, **do NOT remove** `ensure` yet. Better keep it and just make sure it works and surfaces errors correctly.

────────────────────────
TASK 4 – Quick sanity checks
────────────────────────

After the code changes:

1. Run `npm run build` to ensure the project still builds.

2. Run `npm test` (or `npx vitest`) to ensure the existing tests and your new test(s) pass.

3. Run `npm run dev` and manually verify the critical scenario:

   - For a brand-new broker email:
     - Go to `/app/loads/new`.
     - Fill in all required fields (broker email with `@`, driver phone, pickup/delivery, etc.).
     - Click **Create Load**.
   - Expected:
     - If everything is valid:
       - You see a success toast (e.g. “Load created!”),
       - (In dev) you see a log about sending a verification email,
       - You are redirected to `/app/loads`,
       - The new load appears in the list.
     - If something is wrong with the input:
       - You see a clear toast message explaining what field is missing or invalid.
     - If the backend has a deeper error (DB or config issue):
       - You see a toast with a meaningful error message coming from the backend instead of a generic “Failed to create load”.

Make NO other changes beyond what is required to:
- fix the first-load creation bug, and
- provide clear error messages to the user.